- job-template:
    name: '{value_stream}_{name}_packaging-ezbake_multiproject_{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} Build pe-console-services'
    node: worker
    project-type: freestyle
    parameters:
    builders:
        - shell: !include-raw packaging-clj-lein-ezbake-multiproject.sh

    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{tpb_predefined_parameters}'
              current-parameters: '{tpb_current_parameters}'
              condition: '{tpb_condition}'
              property-file: '.props'
              git-revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_pe-console-services_release_{scm_branch}'
    display-name: 'pe-console-services ({scm_branch}): Release & Promote to PE'
    description: |

        This job runs against {git_url} at the {scm_branch} branch.

        It accepts a comma-separated list of project=version tuples representing
        new versions of components that should be included in the
        pe-console-services package.

        It performs the following tasks in order:
            * Updates the given list of pe-console-services dependencies.
            * Bumps the current pe-console-services version to the next "release".
            * Commits this change to the git repo then tags it with the release version.
            * Builds a pe-console-services uberjar and packages for Puppet Enterprise.
            * Bump the current pe-console-services version from its current
              "release" state to the next snapshot level.
            * Pushes the current head and recently-created release snapshot to
              the {scm_branch} branch of pe-console-services repo.
            * Promotes the built package into the {pe_family}.x branch of
              https://github.com/puppetlabs/enterprise-dis

        **NOTE** that if the package building step of this job is successful it
        will COMMIT the project.clj changes to the pe-console-services
        repository.
    node: worker
    project-type: freestyle
    parameters:
        - string:
            name: DEPLIST
            description: |
                Comma-separated list of leiningen deps and versions to set:
                <depname>=<version>[,<depname>=<version>[...]]

                Example: pe-rbac-service=0.3.2,classifier=1.2.2

                Setting this parameter will cause the pe-console-services
                project.clj file to be updated with these new versions. The
                updated versions will be committed to the repo, assuming the
                package builds succeed.

                **NOTE** The value for depname must reference the maven artifact
                name of the project, NOT the git repo name.
    builders:
        - shell:
            !include-raw clj-updatedeps.sh
        - shell:
            !include-raw release-nodeploy-clj.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_enterprise-dist_packaging_promotion'
              property-file: '.props'
              predefined-parameters:
                  PKG={name}
                  BRANCH={scm_branch}
              condition: UNSTABLE_OR_BETTER
