- job-template:
    name: '{value_stream}_{name}_package-ezbake_jjb'
    display-name: 'pe-console-services: Build OS Packages'
    node: worker
    logrotate:
        daysToKeep: 7
        numToKeep: 7
    project-type: freestyle
    parameters:
        - string:
            name: DEP_NAME
            description: "Name of the dependency whose version will get updated."
        - string:
            name: DEP_VERSION
            description: "New version to set on the given DEP_NAME"
        - string:
            name: PE_VER
            default: "3.7"
            description: "Target PE Version"
        - string:
            name: GIT_REF
            default: master
            description: "{name} git reference to build."
        - bool:
            name: COMMIT
            default: false
            description: "If this field is checked, commit dependency changes to pe-console-services repo."
    scm:
        - ezbake-mirror
    builders:
        - git-clone:
            git-repo: git@github.com:puppetlabs/pe-console-services.git
            git-dir-name: pe-console-services
            git-branch: "$GIT_REF"
        - shell:
            !include-raw updatedeps-clj.sh
        - shell:
            !include-raw ezbakedir-packaging-pe.sh
        - shell:
            !include-raw git-push.sh

- job-template:
    name: '{value_stream}_{name}_release-ezbake_jjb'
    display-name: 'pe-console-services: Release & Promote to PE'
    node: worker
    logrotate:
        daysToKeep: 7
        numToKeep: 7
    project-type: freestyle
    parameters:
        - string:
            name: PE_VER
            default: "3.7"
            description: "Target PE Version"
    scm:
        - pe-console-services
    builders:
        - shell:
            !include-raw release-nodeploy-clj.sh
        - trigger-builds:
            - project: '{value_stream}_{name}_package-ezbake_jjb'
              property-file: '.props'
              current-parameters: true
              block: true
    publishers:
        - trigger-parameterized-builds:
            - project: 'Package-Promotion'
              property-file: '.props'
              predefined-parameters:
                  PKG={name}
              condition: UNSTABLE_OR_BETTER
