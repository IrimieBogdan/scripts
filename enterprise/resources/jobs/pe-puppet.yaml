- job-template:
    name: '{value_stream}_{name}_intg-system_{qualifier}'
    display-name: '{name} PE Integration Tests ({qualifier})'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: pe_family
            default: '3.7'
            description: "PE \"family\" to test."
        - string:
            name: pe_version_override
            default: ''
            description: "Override for <pe_version> otherwise obtained from redis."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Platforms on which to test {name}"
        - string:
            name: LAYOUT_AXIS
            default: '{default_layout_axis}'
            description: "Layouts on which to test {name}"
    axes:
        - axis:
            type: dynamic
            name: LAYOUT
            values:
                - LAYOUT_AXIS
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-system-pe.sh

    publishers:
        - beaker-junit-publisher:
            additional: ''
        - description-setter:
            regexp: "export pe_version=([\\w\\-.]+)"
            description: '\1 {beaker_testsuite}'
            regexp-for-failed: "export pe_version=([\\w\\-.]+)"
            description-for-failed: '\1 {beaker_testsuite}'
            set-for-matrix: true

- job-template:
    name: '{value_stream}_{name}_intg-system_windows-{qualifier}'
    display-name: '{name} Windows PE Integration Tests ({qualifier})'
    project-type: matrix
    execution-strategy:
        combination-filter: '!(ARCH == "64" && (AGENT ==~ /windows2003(r2)?-\d\d/))'
    node: beaker
    parameters:
        - string:
            name: pe_family
            default: '3.7'
            description: "PE \"family\" to test."
        - string:
            name: pe_version_override
            default: ''
            description: "Override for <pe_version> otherwise obtained from redis."
        - string:
            name: AGENT_AXIS
            default: '{default_windows-agent_axis}'
            description: "Agent platforms on which to test {name}"
        - string:
            name: ARCH_AXIS
            default: '{default_windows-arch_axis}'
            description: "Architectures on which to run {name} windows tests."
    axes:
        - axis:
            type: dynamic
            name: ARCH
            values:
                - ARCH_AXIS
        - axis:
            type: dynamic
            name: AGENT
            values:
                - AGENT_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-system-pe-windows.sh

    publishers:
        - beaker-junit-publisher:
            additional: ''
        - description-setter:
            regexp: "export pe_version=([\\w\\-.]+)"
            description: '\1 {beaker_testsuite}'
            regexp-for-failed: "export pe_version=([\\w\\-.]+)"
            description-for-failed: '\1 {beaker_testsuite}'
            set-for-matrix: true

- job-template:
    name: '{value_stream}_{name}_init_{qualifier}'
    display-name: '{displayname}'
    defaults: global-no-scm
    node: worker
    parameters:
        - string:
            name: AGENT_AXIS
            default: '{default_windows-agent_axis}'
            description: "Agent platforms on which to test {name}"
        - string:
            name: ARCH_AXIS
            default: '{default_windows-arch_axis}'
            description: "Architectures on which to run {name} windows tests."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Platforms on which to test {name}"
        - string:
            name: LAYOUT_AXIS
            default: '{default_layout_axis}'
            description: "Layouts on which to test {name}"
    disabled: '{kickoff_disabled}'
    project-type: matrix
    execution-strategy:
        sequential: true
    triggers:
        - timed: '{interval}'
    axes:
        - axis:
            type: user-defined
            name: pe_family
            values:
                - 3.7
    builders:
        - shell:
            !include-raw redis-dump-pe_version.sh
        - trigger-builds:
            - project: '{phase-1-projects}'
              property-file: '.props'
              current-parameters: true
              block: true
        - trigger-builds:
            - project: '{phase-2-projects}'
              property-file: '.props'
              current-parameters: true
              block: true

- job-group:
    name: 'qatest-puppet-split-jobs'
    scm_name: qatests
    scm_branch: master
    beaker_loadpath: lib/
    beaker_presuite: suites/puppet/pre-suite/pe_install_env.rb
    preserve_hosts: never
    jobs:
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-puppet_02X
            beaker_testsuite: suites/puppet/tests/02{0,1,2,5}_puppet_resource_*
        - '{value_stream}_{name}_intg-system_windows-{qualifier}':
            qualifier: qatests-puppet_0XX
            beaker_testsuite: suites/puppet/tests/0{2,3}[0-9]*windows
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-puppet_03X
            beaker_testsuite: suites/puppet/tests/030_puppet_resource_mount suites/puppet/tests/031_puppet_resource_exec
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-puppet_041
            beaker_testsuite: suites/puppet/tests/041_puppet_resource_file

- job-group:
    name: 'qatest-pe-split-jobs'
    scm_name: qatests
    scm_branch: master
    beaker_loadpath: lib/
    beaker_presuite: suites/puppet/pre-suite/pe_install_env.rb
    preserve_hosts: never
    jobs:
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe_020_puppet_server_http_ca
            beaker_testsuite: suites/pe/tests/020_puppet_server_http_ca
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-023_reports_processor
            beaker_testsuite: suites/pe/tests/023_pe_reports_processor
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-030_external_ca
            beaker_testsuite: suites/pe/tests/030_pe_external_ca
            beaker_presuite: pre-suite/pre_ste-remote_ca.rb
            LAYOUT_AXIS: 64u-64mda-64f
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-035_puppet_server_basic
            beaker_testsuite: suites/pe/tests/035_puppet_server_basic
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-120_jenkins_user_scenario
            beaker_testsuite: suites/pe/tests/120_jenkins_user_scenario
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-121_jvm_metrics
            beaker_testsuite: suites/pe/tests/121_jvm_metrics
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-122_jvm_stdlib_module
            beaker_testsuite: suites/pe/tests/122_jvm_stdlib_module
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-130_wordpress_user_scenario
            beaker_testsuite: suites/pe/tests/130_wordpress_user_scenario
        - '{value_stream}_{name}_intg-system_{qualifier}':
            qualifier: qatests-pe-215_jvm_inifile_module
            beaker_testsuite: suites/pe/tests/215_jvm_inifile_module
