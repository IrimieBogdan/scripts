- job-template:
    name: '{value_stream}_{name}_packaging-ezbake_multiproject_{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} Build pe-console-services'
    node: worker
    project-type: freestyle
    parameters:
        - string:
            name: PE_VER
            default: "3.7"
            description: "Target PE Version"
    builders:
        - shell: !include-raw packaging-clj-lein-ezbake-multiproject.sh

    publishers:
        - trigger-parameterized-build:
            tpb_projects: '{tpb_projects}'
            tpb_predefined_parameters: '{tpb_predefined_parameters}'
            tpb_current_parameters: '{tpb_current_parameters}'
            tpb_condition: '{tpb_condition}'
            tpb_property_file: '.props'
            tpb_git_revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_pe-console-services_packaging-ezbake'
    display-name: 'pe-console-services: Build OS Packages'
    node: worker
    project-type: freestyle
    parameters:
        - string:
            name: DEPLIST
            description: |
                Comma-separated list of leiningen deps and versions to set:
                <depname>=<version>[,<depname>=<version>[...]]
        - string:
            name: PE_VER
            default: "3.7"
            description: "Target PE Version"
        - bool:
            name: COMMIT_CHANGES
            default: false
            description: |
                If this field is checked, commit dependency changes to
                pe-console-services repo.
    builders:
        - shell:
            !include-raw clj-updatedeps.sh
        - shell:
            !include-raw packaging-clj-lein-ezbake.sh
        - shell:
            !include-raw git-push.sh

- job-template:
    name: '{value_stream}_pe-console-services_release-ezbake'
    display-name: 'pe-console-services: Release & Promote to PE'
    node: worker
    project-type: freestyle
    parameters:
        - string:
            name: PE_VER
            default: "3.7"
            description: "Target PE Version"
    git-url: git@github.com:puppetlabs/pe-console-services.git
    scm_branch: master
    builders:
        - shell:
            !include-raw release-nodeploy-clj.sh
        - trigger-builds:
            - project: '{value_stream}_pe-console-services_package-ezbake'
              property-file: '.props'
              current-parameters: true
              block: true
    publishers:
        - trigger-parameterized-builds:
            - project: 'Package-Promotion'
              property-file: '.props'
              predefined-parameters:
                  PKG={name}
              condition: UNSTABLE_OR_BETTER
- job-group:
    name: 'pe-console-services_packaging-pipelines'
    jobs:
        - '{value_stream}_pe-console-services_packaging-ezbake'
        - '{value_stream}_pe-console-services_release-ezbake'
