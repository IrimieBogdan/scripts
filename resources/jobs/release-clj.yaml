- job-template:
    name: '{value_stream}_{name}_release-clj_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/release-clj.yaml'
    meta_description: |
        <p>This job performs the following tasks: <\p><\br>
        <p>    * Bumps to 'release' version (modifes maven version string in project.clj)<\br><\p>
        <p>    * Commits project.clj change to repo.<\br><\p>
        <p>    * Bumps to ${{VERSION_LEVEL:-patch}} version (modifes maven version string in project.clj)<\br><\p>
        <p>    * Pushes the change to {scm_branch} branch at {git_url}.<\br><\p>
        <p>    * Tags the repo at the release commit.<\br><\p>
        <p>    * Pushes the new tag to {scm_branch} branch at {git_url}.<\br><\p>
        <p>    * Runs 'lein deploy' at the release commit.<\br><\p>

        <p>Please note that this job has a build parameter which allows you to
        set the "next" version level that should incremented.<\p>
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}'
    qualifier: '{scm_branch}'
    dn-qualifier: ' Lein Release'

    git_skip_tag: True

    node: unit
    parameters:
        - string:
            name: VERSION_LEVEL
            default: :patch
            description: |
                Set the version level that should be set by the second version bump in this job.
    builders:
        - shell:
            !include-raw release-clj.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '{obj:tpb_property_file}'
              git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_pe-console-services_release_{scm_branch}'
    meta_path_jobtemplate: 'resources/jobs/release-clj.yaml'
    display-name: 'pe-console-services ({scm_branch}): Release & Promote to PE'

    git_skip_tag: True

    description: |

        <p>This job runs against {git_url} at the {scm_branch} branch.<\p>

        <p>It accepts a comma-separated list of project=version tuples representing
        new versions of components that should be included in the
        pe-console-services package.<\p>

        <p>It performs the following tasks in order:<\p>
        <p>    * Updates the given list of pe-console-services dependencies.<\p>
        <p>    * Bumps the current pe-console-services version to the next "release".<\p>
        <p>    * Commits this change to the git repo then tags it with the release version.<\p>
        <p>    * Builds a pe-console-services uberjar and packages for Puppet Enterprise.<\p>
        <p>    * Bump the current pe-console-services version from its current
              "release" state to the next snapshot level.<\p>
        <p>    * Pushes the current head and recently-created release snapshot to
              the {scm_branch} branch of pe-console-services repo.<\p>
        <p>    * Promotes the built package into the {pe_family}.x branch of
              https://github.com/puppetlabs/enterprise-dis<\p>

        <p>**NOTE** that if the package building step of this job is successful it
        will COMMIT the project.clj changes to the pe-console-services
        repository.<\p>
    node: worker
    project-type: freestyle
    parameters:
        - string:
            name: DEPLIST
            description: |
                Comma-separated list of leiningen deps and versions to set:
                <depname>=<version>[,<depname>=<version>[...]]

                Example: pe-rbac-service=0.3.2,classifier=1.2.2

                Setting this parameter will cause the pe-console-services
                project.clj file to be updated with these new versions. The
                updated versions will be committed to the repo, assuming the
                package builds succeed.

                **NOTE** The value for depname must reference the maven artifact
                name of the project, NOT the git repo name.
    builders:
        - shell:
            !include-raw clj-updatedeps.sh
        - shell:
            !include-raw release-nodeploy-clj.sh
        - trigger-builds:
            - project: '{value_stream}_enterprise-dist_packaging_promotion'
              property-file: '.props'
              predefined-parameters: |
                  PKG={name}
                  BRANCH={scm_branch}
              block: True
