- job-template:
    name: '{value_stream}_classifier_unit-jruby_{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} JRuby Unit Tests'
    node: unit
    builders:
        - shell: |
            #!/usr/bin/env bash

            set -e
            set -x

            #-------------------------------------------------------------------------------
            # Set variable defaults

            export PUPPET_REPO=${{PUPPET_REPO:-{puppet_repo}}}
            export PUPPET_BRANCH=${{PUPPET_BRANCH:-{puppet_branch}}}
            export GEM_SOURCE=${{GEM_SOURCE:-{gem_source}}}
            export RVM_RUBY_VERSION=${{RVM_RUBY_VERSION:-{rvm_ruby_version}}}

            export PUPPET_LOCATION="$PUPPET_REPO#$PUPPET_BRANCH"

            #-------------------------------------------------------------------------------
            # Configure Ruby

            source /usr/local/rvm/scripts/rvm
            rvm use $RVM_RUBY_VERSION

            #-------------------------------------------------------------------------------
            # Set Java JDK version based on current matrix value of JDK_BIN_PATH which
            # should be a path to the bin directory of the desired JDK.

            if [ ! -z "$JDK_BIN_PATH" ] ;then
                export PATH="$JDK_BIN_PATH:$PATH"
            fi

            #-------------------------------------------------------------------------------
            # Print interesting system information

            echo
            echo "Print Java version"
            java -version

            echo
            echo "Install Leiningen 2.5.1"
            mkdir -p tmp/bin
            cd tmp/bin
            wget https://raw.githubusercontent.com/technomancy/leiningen/2.5.1/bin/lein
            chmod u+x lein
            cd ../../

            export PATH=$WORKSPACE/tmp/bin:$PATH

            echo
            echo "Print Leiningen version"
            ./tmp/bin/lein version

            echo
            echo "Print Gem list"
            gem list --all

            echo
            echo "Print environment list"
            printenv | sort

            echo
            echo "For some reason there are cases where 'java' will get added to PLATFORMS"
            git checkout HEAD Gemfile.lock

            #-------------------------------------------------------------------------------
            # Meat and potatoes.

            echo
            echo "Run JRuby Spec tests"
            rake spec
    publishers:
        - trigger-parameterized-build:
            tpb_projects: '{tpb_projects}'
            tpb_predefined_parameters: '{tpb_predefined_parameters}'
            tpb_current_parameters: '{tpb_current_parameters}'
            tpb_condition: '{tpb_condition}'
            tpb_property_file: '{tpb_property_file}'
            tpb_git_revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_unit-jruby_{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} JRuby Unit Tests'
    node: unit
    builders:
        - shell:
            !include-raw-escape unit-jruby.sh

    publishers:
        - trigger-parameterized-build:
            tpb_projects: '{tpb_projects}'
            tpb_predefined_parameters: '{tpb_predefined_parameters}'
            tpb_current_parameters: '{tpb_current_parameters}'
            tpb_condition: '{tpb_condition}'
            tpb_property_file: '{tpb_property_file}'
            tpb_git_revision: '{tpb_git_revision}'
