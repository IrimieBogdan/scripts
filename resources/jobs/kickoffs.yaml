- job-template:
    name: '{value_stream}_{name}_init-merge_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{scm_branch}'
            submodule:
                recursive: True
            excluded-regions: '{obj:git_excluded_regions}'
            included-regions: '{obj:git_included_regions}'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}Mergely Kickoff'
    node: worker
    disabled: '{obj:kickoff_disabled}'
    project-type: freestyle
    triggers:
        - pollscm: "H/5 * * * *"
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{tpb_predefined_parameters}'
              current-parameters: '{tpb_current_parameters}'
              condition: '{tpb_condition}'
              property-file: '{tpb_property_file}'
              git-revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_init-periodic_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{scm_branch}'
            submodule:
                recursive: True
            excluded-regions: '{obj:git_excluded_regions}'
            included-regions: '{obj:git_included_regions}'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}Periodic Kickoff'
    node: worker
    disabled: '{obj:kickoff_disabled}'
    project-type: freestyle
    triggers:
        - timed: '{obj:timed_trigger_cron}'
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{tpb_predefined_parameters}'
              current-parameters: '{tpb_current_parameters}'
              condition: '{tpb_condition}'
              property-file: '{tpb_property_file}'
              git-revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_init_nightly-{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{scm_branch}'
            submodule:
                recursive: True
            excluded-regions: '{obj:git_excluded_regions}'
            included-regions: '{obj:git_included_regions}'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}Nightly Kickoff'
    node: worker
    disabled: '{obj:kickoff_disabled}'
    project-type: freestyle
    triggers:
        - timed: "@midnight"
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '{obj:tpb_property_file}'
              git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_init-manual_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    parameters:
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "List of platforms for user-defined PLAFORM axis."
        - string:
            name: LAYOUT_AXIS
            default: '{default_layout_axis}'
            description: "List of layouts for user-defined LAYOUT axis."
        - string:
            name: GIT_SHA
            default: 'master'
            description: |
                This sets the GIT_SHA against which the entire pipeline should be built.
        - string:
            name: SHIP_NIGHTLY
            default: 'FALSE'
            description: |
                If this job happens to trigger nightly builds, then make sure
                the nightly build is shipped by intention only.
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '$GIT_SHA'
            submodule:
                recursive: True
            excluded-regions: '{obj:git_excluded_regions}'
            included-regions: '{obj:git_included_regions}'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}Manual Kickoff'
    node: worker
    disabled: False
    project-type: freestyle
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '{obj:tpb_property_file}'
              git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_init-gpr_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} PR Kickoff [{dn-qualifier}]'
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{scm_branch}'
            refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
            submodule:
                recursive: True
            excluded-regions: '{obj:git_excluded_regions}'
            included-regions: '{obj:git_included_regions}'
    node: worker
    triggers:
        - github-pull-request:
            admin-list: '{obj:gpr_admin_list}'
            cron: '{obj:gpr_cron}'
            org-list: '{obj:gpr_orgs}'
            trigger-phrase: '{obj:gpr_trigger_phrase}'
            only-trigger-phrase: '{obj:gpr_only_trigger_phrase}'
            permit-all: '{obj:gpr_permit_all}'
    builders: '{obj:gpr_builders}'

- job-template:
    name: '{value_stream}_pe-acceptance-tests_init-periodic_{scm_branch}'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}Kickoff'
    scm:
        - git:
            url: '{git_url}'
            branches:
                - '{scm_branch}'
    node: worker
    wrappers:
        - ansicolor:
            colormap: xterm
    disabled: '{obj:kickoff_disabled}'
    project-type: freestyle
    triggers:
        - timed: "@midnight"
    builders:
        - trigger-builds:
            - project: '{obj:phase1_projects}'
              block: True
    publishers:
        - claim-build
        - trigger-parameterized-builds:
            - project: '{obj:phase2_projects}'
              predefined-parameters: |
                  BOGUS=yes
              current-parameters: False
              condition: 'ALWAYS'

- job-template:
    name: '{value_stream}_pe-acceptance-tests_init_compose-shim'
    meta_path_jobtemplate: 'resources/jobs/kickoffs.yaml'
    scm_branch: '3.7.x'
    description: |
        This job is intended to act as a shim between the
        jenkins-compose.delivery.puppetlabs.net PE Compose jobs and the new
        per-PE integration pipelines. The compose jobs expect a single job
        parameterized on the version of PE being built which is incompatible
        with the new PE pipelines.
    display-name: '{name} {dn-sort-index} PE Compose Shim'
    node: worker
    parameters:
        - string:
            name: pe_family
        - string:
            name: pe_version
    disabled: '{obj:kickoff_disabled}'
    project-type: freestyle
    builders:
        - conditional-step:
            condition-kind: strings-match
            condition-string1: '${{ENV,var="pe_family"}}'
            condition-string2: '3.7'
            on-evaluation-failure: 'dont-run'
            steps:
                - trigger-builds:
                    - project: '{value_stream}_{name}_integration-system_pe_smoke-monolithic_3.7.x'
                      block: False
                      current-parameters: True
        - conditional-step:
            condition-kind: strings-match
            condition-string1: '${{ENV,var="pe_family"}}'
            condition-string2: '3.8'
            on-evaluation-failure: 'dont-run'
            steps:
                - trigger-builds:
                    - project: '{value_stream}_{name}_integration-system_pe_smoke-monolithic_3.8.x'
                      block: False
                      current-parameters: True
        - conditional-step:
            condition-kind: strings-match
            condition-string1: '${{ENV,var="pe_family"}}'
            condition-string2: '3.99'
            on-evaluation-failure: 'dont-run'
            steps:
                - trigger-builds:
                    - project: '{value_stream}_{name}_integration-system_pe_smoke-monolithic_3.99.x'
                      block: False
                      current-parameters: True
        - conditional-step:
            condition-kind: strings-match
            condition-string1: '${{ENV,var="pe_family"}}'
            condition-string2: '4.0'
            on-evaluation-failure: 'dont-run'
            steps:
                - trigger-builds:
                    - project: '{value_stream}_{name}_integration-system_pe_smoke-monolithic_4.0.x'
                      block: False
                      current-parameters: True
