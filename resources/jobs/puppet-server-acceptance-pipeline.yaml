- job-template:
    name: '{value_stream}_{name}_init-merge_jjb'
    display-name: '{name} 00: Mergely Kickoff'
    node: worker
    logrotate:
        daysToKeep: -1
        numToKeep: -1
    project-type: freestyle
    scm:
        - '{name}'
    triggers:
        - pollscm: "H/5 * * * *"
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-clj_jjb'
              predefined-parameters: "PLATFORM_AXIS=el-6 ubuntu-1404"
              current-parameters: False
              condition: ALWAYS
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_init_nightly-jjb'
    display-name: '{name} 00: Nightly Kickoff'
    node: worker
    logrotate:
        daysToKeep: -1
        numToKeep: -1
    project-type: freestyle
    scm:
        - '{name}'
    triggers:
        - timed: "@midnight"
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-clj_jjb'
              predefined-parameters: "PLATFORM_AXIS=el-6 el-7 redhat-5 redhat-6 redhat-7 debian-6 ubuntu-1204 ubuntu-1404"
              current-parameters: False
              condition: ALWAYS
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_unit-clj_jjb'
    display-name: '{name} 01: Clojure Unit Tests'
    node: unit
    scm:
        - '{name}'
    builders:
        - shell:
            !include-raw-escape unit-clj.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-jruby_jjb'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_unit-jruby_jjb'
    display-name: '{name} 05: JRuby Unit Tests'
    node: unit
    scm:
        - '{name}'
    builders:
        - shell:
            !include-raw-escape unit-jruby.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_packaging-nexus-clj_jjb'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_packaging-nexus-clj_jjb'
    display-name: '{name} 10: Lein Deploy'
    node: worker
    scm:
        - '{name}'
    builders:
        - shell:
            !include-raw-escape package-nexus.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_packaging-os-clj_jjb'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_packaging-os-clj_jjb'
    display-name: '{name} 15: Packaging Uberbuild'
    node: worker
    parameters:
        - string:
            name: LEIN_PROJECT_VERSION
            description: "Maven artifact version to build."
    scm:
        - ezbake-mirror
    builders:
        - shell:
            !include-raw ezbake-packaging-foss.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_integration-system_smoke-jjb'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_integration-system_smoke-jjb'
    display-name: '{name} 20: Integration Smoke Test Suite'
    project-type: matrix
    node: beaker
    logrotate:
        daysToKeep: 5
        numToKeep: 5
    parameters:
        - string:
            name: PACKAGE_BUILD_VERSION
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Version of {name} to use in test."
    scm:
        - '{name}'
    axes:
        - axis:
            type: user-defined
            name: LAYOUT
            values: 
                - x86_64-mdca 
                - x86_64-mdca-a
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw-escape integration-system.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_integration-system_full-jjb'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_integration-system_full-jjb'
    display-name: '{name} 25: Integration Full Test Suite'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: PACKAGE_BUILD_VERSION
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Platforms on which to test {name}"
    scm:
        - '{name}'
    axes:
        - axis:
            type: user-defined
            name: LAYOUT
            values: 
                - x86_64-mdca 
                - x86_64-mdca-a
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw-escape integration-system-full.sh

- job-group:
    name: '{value_stream}_{name}_demo-pipeline_jjb'
    jobs:
        - '{value_stream}_{name}_init-merge_jjb'
        - '{value_stream}_{name}_init_nightly-jjb'
        - '{value_stream}_{name}_unit-clj_jjb'
        - '{value_stream}_{name}_unit-jruby_jjb'
        - '{value_stream}_{name}_packaging-nexus-clj_jjb'
        - '{value_stream}_{name}_packaging-os-clj_jjb'
        - '{value_stream}_{name}_integration-system_full-jjb'
        - '{value_stream}_{name}_integration-system_smoke-jjb'
