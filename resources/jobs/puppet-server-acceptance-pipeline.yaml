- job-template:
    name: '{value_stream}_{name}_init-merge_{scm_branch}'
    display-name: '{name} ({scm_branch}) 00: Mergely Kickoff'
    node: worker
    disabled: '{kickoff_disabled}'
    project-type: freestyle
    triggers:
        - pollscm: "H/5 * * * *"
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-clj_{scm_branch}'
              predefined-parameters: "PLATFORM_AXIS=el-6 ubuntu-1404"
              current-parameters: False
              condition: ALWAYS
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_init_nightly-{scm_branch}'
    display-name: '{name} ({scm_branch}) 00: Nightly Kickoff'
    node: worker
    disabled: '{kickoff_disabled}'
    project-type: freestyle
    triggers:
        - timed: "@midnight"
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-clj_{scm_branch}'
              predefined-parameters: "PLATFORM_AXIS=el-6 el-7 redhat-5 redhat-6 redhat-7 ubuntu-1204 ubuntu-1404"
              current-parameters: False
              condition: ALWAYS
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_unit-clj_{scm_branch}'
    display-name: '{name} ({scm_branch}) 01: Clojure Unit Tests'
    node: unit
    builders:
        - shell:
            !include-raw-escape unit-clj.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_unit-jruby_{scm_branch}'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_unit-jruby_{scm_branch}'
    display-name: '{name} ({scm_branch}) 05: JRuby Unit Tests'
    node: unit
    builders:
        - shell:
            !include-raw-escape unit-jruby.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_packaging-nexus-clj_{scm_branch}'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_packaging-nexus-clj_{scm_branch}'
    display-name: '{name} ({scm_branch}) 10: Lein Deploy'
    node: worker
    builders:
        - shell:
            !include-raw-escape package-nexus.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_packaging-os-clj_{scm_branch}'
              current-parameters: True
              property-file: '.props'
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_packaging-os-clj_{scm_branch}'
    display-name: '{name} ({scm_branch}) 15: Packaging Uberbuild'
    node: worker
    metadata:
        - string:
            name: SCRIPT_DIR
            value: ezbake
            expose-to-env: true
    parameters:
        - string:
            name: LEIN_PROJECT_VERSION
            description: "Maven artifact version to build."
    builders:
        - git-clone:
            git-repo: git@github.com:puppetlabs/ezbake.git
            git-dir-name: ezbake
        - ezbake-packaging-foss:
            script_dir: ezbake
            ezbake_package_name: '{ezbake_package_name}'
            maven_artifact_name: '{maven_artifact_name}'
    publishers:
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_integration-system_smoke-{scm_branch},{value_stream}_{name}_integration-system_smoke-upgrade-{scm_branch}'
              current-parameters: True
              property-file: '.props'
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_integration-system_smoke-upgrade-{scm_branch}'
    display-name: '{name} ({scm_branch}) 21: Integration Upgrade Smoke Test'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: PACKAGE_BUILD_VERSION
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Version of {name} to use in test."
    axes:
        - axis:
            type: user-defined
            name: LAYOUT
            values:
                - x86_64-mdca
                - x86_64-mdca-a
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-system.sh
    publishers:
        - puppet-server-junit

- job-template:
    name: '{value_stream}_{name}_integration-system_smoke-{scm_branch}'
    display-name: '{name} ({scm_branch}) 20: Integration Smoke Test Suite'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: PACKAGE_BUILD_VERSION
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Version of {name} to use in test."
    axes:
        - axis:
            type: user-defined
            name: LAYOUT
            values:
                - x86_64-mdca
                - x86_64-mdca-a
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-system.sh
    publishers:
        - puppet-server-junit
        - trigger-parameterized-builds:
            - project: '{value_stream}_{name}_integration-system_full-{scm_branch}'
              current-parameters: True
              condition: UNSTABLE_OR_BETTER
              git-revision: True

- job-template:
    name: '{value_stream}_{name}_integration-system_full-{scm_branch}'
    display-name: '{name} ({scm_branch}) 25: Integration Full Test Suite'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: PACKAGE_BUILD_VERSION
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "Platforms on which to test {name}"
    axes:
        - axis:
            type: user-defined
            name: LAYOUT
            values:
                - x86_64-mdca
                - x86_64-mdca-a
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-system-full.sh
    publishers:
        - puppet-server-junit

- job-group:
    name: '{value_stream}_{name}_foss-pipeline_{scm_branch}'
    jobs:
        - '{value_stream}_{name}_init-merge_{scm_branch}'
        - '{value_stream}_{name}_init_nightly-{scm_branch}'
        - '{value_stream}_{name}_unit-clj_{scm_branch}'
        - '{value_stream}_{name}_unit-jruby_{scm_branch}'
        - '{value_stream}_{name}_packaging-nexus-clj_{scm_branch}'
        - '{value_stream}_{name}_packaging-os-clj_{scm_branch}'
        - '{value_stream}_{name}_integration-system_full-{scm_branch}'
        - '{value_stream}_{name}_integration-system_smoke-upgrade-{scm_branch}':
            additional_exports: 'export PUPPETSERVER_INSTALL_MODE=upgrade'
        - '{value_stream}_{name}_integration-system_smoke-{scm_branch}'
