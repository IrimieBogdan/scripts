- job-template:
    # This unit test is meant to be used for both classifier and classifier-ui,
    # both of which have similar database fixture needs.
    name: '{value_stream}_{name}_unit-clj_classifier_{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} Classifier Unit Test'
    node: worker
    builders:
        - shell: |
            #!/usr/bin/env bash
            set -x
            set -e

            export DBHOST=vasu.delivery.puppetlabs.net
            export DBUSER={pgdb_user}
            export DBPORT=5432

            echo
            echo "Set database passwords."
            export RBAC_DBPASS={pgdb_password}
            export ACTIVITY_DBPASS={pgdb_password}
            export CLASSIFIER_DBPASS={pgdb_password}
            export PGPASSWORD={pgdb_password}

            # Generate a temporary database identifier
            DB_ID=`echo "nc_unit_$BUILD_ID" | tr - _`
            RBAC_DB_ID=`echo "nc_unit_rbac_$BUILD_ID" | tr - _`
            ACTIVITY_DB_ID=`echo "nc_unit_activity_$BUILD_ID" | tr - _`

            export CLASSIFIER_DBSUBNAME="//$DBHOST:$DBPORT/$DB_ID"
            export CLASSIFIER_DBUSER="$DBUSER"

            export RBAC_DBNAME="//$DBHOST:$DBPORT/$RBAC_DB_ID"
            export RBAC_DBUSER="$DBUSER"
            export RBAC_DBPASS="$PGPASSWORD"

            export ACTIVITY_DBNAME="//$DBHOST:$DBPORT/$ACTIVITY_DB_ID"
            export ACTIVITY_DBUSER="$DBUSER"
            export ACTIVITY_DBPASS="$PGPASSWORD"

            echo
            echo "Create temporary database names."
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "create database $DB_ID"
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "create database $RBAC_DB_ID"
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "create database $ACTIVITY_DB_ID"

            if [ "$DBUSER" = "rbac" ] ;then
                echo
                echo "Running with DBUSER=rbac, do this special thing."
                psql -h "$DBHOST" -U "$DBUSER" -d "$RBAC_DB_ID" -c "create extension citext"
            fi

            if [ ! -z "$JDK_BIN_PATH" ] ;then
                export PATH="$JDK_BIN_PATH:$PATH"
            fi

            java -version

            echo
            echo "Install Leiningen 2.5.1"
            wget https://raw.githubusercontent.com/technomancy/leiningen/2.5.1/bin/lein
            chmod u+x lein

            echo
            echo "Run leiningen tests."
            ./lein version
            ./lein -U test :all

            echo
            echo "Clean up databases"
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "drop database $DB_ID"
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "drop database $RBAC_DB_ID"
            psql -h "$DBHOST" -U "$DBUSER" -d postgres -c "drop database $ACTIVITY_DB_ID"

            set -x
            set -e
    publishers:
        - trigger-parameterized-build:
            tpb_projects: '{tpb_projects}'
            tpb_predefined_parameters: '{tpb_predefined_parameters}'
            tpb_current_parameters: '{tpb_current_parameters}'
            tpb_condition: '{tpb_condition}'
            tpb_property_file: '{tpb_property_file}'
            tpb_git_revision: '{tpb_git_revision}'
