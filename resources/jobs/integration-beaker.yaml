- job-template:
    name: '{value_stream}_{name}_integration-system_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/integration-beaker.yaml'
    meta_description: |
        This job honors the build parameter named by the JJB variable
        "condition_param_varname" to determine whether or not to trigger its
        downstream job. By default this job-template does not have this JJB
        variable defined; if the job-template instance that is used to reify
        this job does not set a value here then the downstream job will always
        be triggered, making the conditional trigger "opt-in" behavior.
        Hopefully this description doesn't confuse anyone.
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier} Acceptance Test Suite'
    project-type: matrix
    node: beaker
    execution-strategy:
        combination-filter: '{combination-filter}'
    axes:
        - axis:
            type: dynamic
            name: LDAP_TYPE
            values:
                - LDAP_TYPE_AXIS
        - axis:
            type: dynamic
            name: LAYOUT
            values:
                - LAYOUT_AXIS
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-beaker.sh
    publishers:
        - claim-build
        - archive:
            artifacts: '{archive_artifacts_glob}'
            allow-empty: true
        - junit:
            results: '{junit_results_glob}'
            claim-build: true
            test-stability: true
        - conditional-publisher:
            - condition-kind: shell
              condition-command: |
                  #!/usr/bin/env bash

                  if [ -z "{condition_param_varname}" ] ;then
                      # JJB variable 'condition_param_varname undefined, so
                      # always trigger parameterized downstream job.
                      exit 0
                  fi

                  if [ "${condition_param_varname}" = "TRUE"] ;then
                      exit 0
                  fi
                  exit 1
              action:
                  - trigger-parameterized-builds:
                      - project: '{obj:tpb_projects}'
                        predefined-parameters: '{obj:tpb_predefined_parameters}'
                        current-parameters: '{obj:tpb_current_parameters}'
                        condition: '{obj:tpb_condition}'
                        property-file: '{obj:tpb_property_file}'
                        git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_integration-system_pe_{qualifier}_{scm_branch}'
    meta_path_jobtemplate: 'resources/jobs/integration-beaker.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}'
    dn-qualifier: 'Integration'
    project-type: matrix
    node: beaker
    ds_regexp: 'export pe_version=([\w\-.]+)'
    ds_desc: '\1'
    ds_regexp_for_failed: 'export pe_version=([\w\-.]+)'
    ds_desc_for_failed: '\1'
    parameters:
        - string:
            name: pe_version
            description: "Version of {name} to use in test."
    execution-strategy:
        combination-filter: '{combination-filter}'
    axes:
        - axis:
            type: user-defined
            name: UPGRADE_FROM
            values: '{obj:upgrade_from_axis}'
        - axis:
            type: user-defined
            name: LAYOUT
            values: '{obj:layout_axis}'
        - axis:
            type: user-defined
            name: PLATFORM
            values: '{obj:platform_axis}'
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-beaker.sh
    publishers:
        - claim-build
        - archive:
            artifacts: '{archive_artifacts_glob}'
            allow-empty: true
        - junit:
            results: '{junit_results_glob}'
            claim-build: true
            test-stability: true
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{tpb_predefined_parameters}'
              current-parameters: '{tpb_current_parameters}'
              condition: '{tpb_condition}'
              property-file: '{tpb_property_file}'
              git-revision: '{tpb_git_revision}'
        - description-setter:
            regexp: '{ds_regexp}'
            description: '{ds_desc}'
            regexp-for-failed: '{ds_regexp_for_failed}'
            description-for-failed: '{ds_desc_for_failed}'
            set-for-matrix: true

- job-template:
    name: '{value_stream}_{name}_integration-system_windows-{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/integration-beaker.yaml'
    display-name: '{name} Windows PE Integration Tests ({qualifier})'
    project-type: matrix
    execution-strategy:
        combination-filter: '!(ARCH == "64" && (AGENT ==~ /windows2003(r2)?-\d\d/))'
    node: beaker
    parameters:
        - string:
            name: pe_family
            default: '3.7'
            description: "PE \"family\" to test."
        - string:
            name: pe_version_override
            default: ''
            description: "Override for <pe_version> otherwise obtained from redis."
    execution-strategy:
        combination-filter: '{combination-filter}'
    axes:
        - axis:
            type: user-defined
            name: ARCH
            values: '{obj:default_windows-arch_axis}'
        - axis:
            type: user-defined
            name: AGENT
            values: '{obj:default_windows-agent_axis}'
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-beaker.sh

    publishers:
        - claim-build
        - archive:
            artifacts: '{archive_artifacts_glob}'
            allow-empty: true
        - junit:
            results: '{junit_results_glob}'
            claim-build: true
            test-stability: true
        - description-setter:
            regexp: "export pe_version=([\\w\\-.]+)"
            description: '\1 {beaker_testsuite}'
            regexp-for-failed: "export pe_version=([\\w\\-.]+)"
            description-for-failed: '\1 {beaker_testsuite}'
            set-for-matrix: true

- job-template:
    name: '{value_stream}_ezbake_integration-system_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/integration-beaker.yaml'
    display-name: '{name} ({ezbake_git_branch}){dn-sort-index} {dn-qualifier} Acceptance Test Suite'
    project-type: matrix
    node: beaker
    parameters:
        - string:
            name: '{package_build_version_varname}'
            description: "Version of {name} to use in test."
        - string:
            name: PLATFORM_AXIS
            default: '{default_platform_axis}'
            description: "List of platforms for user-defined PLAFORM axis."
        - string:
            name: LAYOUT_AXIS
            default: '{default_layout_axis}'
            description: "List of layouts for user-defined LAYOUT axis."
        - string:
            name: LDAP_TYPE_AXIS
            default: '{default_ldap_type_axis}'
            description: 'List of LDAP service types. Known types include active directory and openldap'
        - string:
            name: SHIP_NIGHTLY
            default: 'FALSE'
            description: |
                If this job happens to trigger nightly builds, then make sure
                the nightly build is shipped by intention only.
    execution-strategy:
        combination-filter: '{combination-filter}'
    axes:
        - axis:
            type: dynamic
            name: LDAP_TYPE
            values:
                - LDAP_TYPE_AXIS
        - axis:
            type: dynamic
            name: LAYOUT
            values:
                - LAYOUT_AXIS
        - axis:
            type: dynamic
            name: PLATFORM
            values:
                - PLATFORM_AXIS
        - axis:
            type: slave
            name: label
            values:
                - beaker
    builders:
        - shell:
            !include-raw integration-beaker.sh
    publishers:
        - claim-build
        - archive:
            artifacts: '{archive_artifacts_glob}'
            allow-empty: true
        - junit:
            results: '{junit_results_glob}'
            claim-build: true
            test-stability: true
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '{obj:tpb_property_file}'
              git-revision: '{obj:tpb_git_revision}'

