- job-template:
    name: '{value_stream}_{name}_packaging-nexus-clj_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/packaging-clj.yaml'
    meta_description: |
        This job is intended to provide developers a more granular approach to
        the release of the projects they are responsible for by allowing them to
        run 'lein deploy' from a specific git SHA on their repository.

        The job takes a single necessary build parameter, "GIT_SHA", which will
        be used to check out a specific branch/tag/sha from {git_url}.
    qualifier: '{scm_branch}'
    display-name: '{name} ({scm_branch}){dn-sort-index} Lein Deploy'
    node: worker
    scm:
        - git:
            url: '{git_url}'
            refspec: '{obj:git_refspec}'
            submodule:
                recursive: True
            branches:
                - '${{GIT_SHA}}'
            skip-tag: '{git_skip_tag}'
    parameters:
        - string:
            name: 'GIT_SHA'
            description: |
                Version of {name} to use when deploying.
    builders:
        - shell:
            !include-raw-escape packaging-clj-lein-deploy.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '.props'
              git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_packaging-os-clj_{scm_branch}'
    meta_path_jobtemplate: 'resources/jobs/packaging-clj.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} Packaging Uberbuild'
    node: worker
    parameters:
        - string:
            name: LEIN_PROJECT_VERSION
            description: "Maven artifact version to build."
        - string:
            name: PE_VER
            default: '{default_PE_VER}'
            description: "Maven artifact version to build."

    builders:
        - shell: |
            #!/usr/bin/env bash

            GIT_REPO="${{GIT_REPO:-{ezbake-git-repo}}}"
            GIT_REF="${{GIT_REF:-{ezbake-git-branch}}}"

            set -x
            set -e

            echo
            echo "Clone git repository."
            git clone git@github.com:puppetlabs/ezbake.git ezbake

            if [ ! -z "$GIT_REF" ] ;then
                cd ezbake

                echo
                echo "Checkout given ref"
                git checkout $GIT_REF
            fi
        - shell: !include-raw ezbake-packaging-foss.sh

    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{tpb_predefined_parameters}'
              current-parameters: '{tpb_current_parameters}'
              condition: '{tpb_condition}'
              property-file: '.props'
              git-revision: '{tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_packaging-os-clj_lein-ezbake_{scm_branch}'
    meta_path_jobtemplate: 'resources/jobs/packaging-clj.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} Lein EZBake'
    node: worker
    parameters:
        - string:
            name: PE_VER
            default: '{default_PE_VER}'
            description: "Maven artifact version to build."
    builders:
        - shell:
            !include-raw packaging-clj-lein-ezbake.sh
    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '.props'
              git-revision: '{obj:tpb_git_revision}'

- job-template:
    name: '{value_stream}_{name}_packaging-ezbake_multiproject_{qualifier}'
    meta_path_jobtemplate: 'resources/jobs/packaging-clj.yaml'
    display-name: '{name} ({scm_branch}){dn-sort-index} {dn-qualifier}'
    dn-qualifier: 'Build {packaging_github_project} for PE {pe_family}'
    node: worker
    project-type: freestyle
    parameters:
    builders:
        - shell: !include-raw packaging-clj-lein-ezbake-multiproject.sh

    publishers:
        - trigger-parameterized-builds:
            - project: '{obj:tpb_projects}'
              predefined-parameters: '{obj:tpb_predefined_parameters}'
              current-parameters: '{obj:tpb_current_parameters}'
              condition: '{obj:tpb_condition}'
              property-file: '.props'
              git-revision: '{obj:tpb_git_revision}'
